{"code":"/**\r\n * @author Jonathan Terrell <terrell.jm@gmail.com>\r\n * @copyright 2023 Jonathan Terrell\r\n * @file datapos-connector-data-file-store-emulator/src/index.ts\r\n * @license ISC\r\n */\r\n// Asset dependencies.\r\nimport config from './config.json';\r\nimport { version } from '../package.json';\r\nimport { ConnectionEntryPreviewTypeId, ConnectionEntryTypeId, extractExtensionFromEntryPath, extractLastFolderNameFromFolderPath, lookupMimeTypeForFileExtension } from '@datapos/datapos-engine';\r\n// ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\r\n// #region Declarations\r\n// ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\r\nconst defaultChunkSize = 4096;\r\nconst urlPrefix = 'https://firebasestorage.googleapis.com/v0/b/datapos-v00-dev-alpha.appspot.com/o/fileStore';\r\n// #endregion\r\n// ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\r\n// #region Data Connector\r\n// ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\r\n/**\r\n * Encapsulates the File Store Emulator data connector.\r\n */\r\nexport default class FileStoreEmulatorDataConnector {\r\n    abortController;\r\n    connectionItem;\r\n    id;\r\n    version;\r\n    constructor(connectionItem) {\r\n        this.abortController = undefined;\r\n        this.connectionItem = connectionItem;\r\n        this.id = config.id;\r\n        this.version = version;\r\n    }\r\n    /**\r\n     * Abort current processing.\r\n     */\r\n    abort() {\r\n        if (!this.abortController)\r\n            return;\r\n        this.abortController.abort();\r\n        this.abortController = undefined;\r\n    }\r\n    /**\r\n     * Get the preview interface.\r\n     * @returns The preview interface.\r\n     */\r\n    getPreviewInterface() {\r\n        return { connector: this, previewFileEntry };\r\n    }\r\n    /**\r\n     * Get the read interface.\r\n     * @returns The read interface.\r\n     */\r\n    getReadInterface() {\r\n        return { connector: this, readFileEntry };\r\n    }\r\n    /**\r\n     * Retrieve a page of entries for a given folder path.\r\n     * @param accountId The identifier of the account to which the source belongs.\r\n     * @param sessionAccessToken An active session access token.\r\n     * @param parentConnectionEntry\r\n     * @returns A page of entries.\r\n     */\r\n    async retrieveEntries(accountId, sessionAccessToken, parentConnectionEntry) {\r\n        return await retrieveEntries(parentConnectionEntry);\r\n    }\r\n}\r\n// #endregion\r\n// ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\r\n// #region Retrieve Entries\r\n// ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\r\n/**\r\n * Retrieve a page of entries for a given folder path.\r\n * @param parentConnectionEntry\r\n * @returns A page of entries.\r\n */\r\nconst retrieveEntries = (parentConnectionEntry) => {\r\n    return new Promise((resolve, reject) => {\r\n        try {\r\n            const folderPath = parentConnectionEntry.folderPath || '';\r\n            const entries = [];\r\n            if (folderPath.startsWith('/SAP Employee Central Extract')) {\r\n                entries.push(buildFileEntry('/SAP Employee Central Extract', 'ADDRESS_INFO.csv', 208015));\r\n                entries.push(buildFileEntry('/SAP Employee Central Extract', 'COMP_CUR_CONV.csv', 2245));\r\n                entries.push(buildFileEntry('/SAP Employee Central Extract', 'EMP_COMP_INFO.csv', 1665179));\r\n                entries.push(buildFileEntry('/SAP Employee Central Extract', 'EMP_PAYCOMP_RECURRING.csv', 1551764));\r\n                entries.push(buildFileEntry('/SAP Employee Central Extract', 'EMPLOYMENT_INFO.csv', 128575));\r\n                entries.push(buildFileEntry('/SAP Employee Central Extract', 'EVENT_REASONS.csv', 7775));\r\n                entries.push(buildFileEntry('/SAP Employee Central Extract', 'FREQUENCY.csv', 1704));\r\n                entries.push(buildFileEntry('/SAP Employee Central Extract', 'GENERIC_OBJECTS.csv', 1662477));\r\n                entries.push(buildFileEntry('/SAP Employee Central Extract', 'GENERIC_RELATIONSHIPS.csv', 98782));\r\n                entries.push(buildFileEntry('/SAP Employee Central Extract', 'JOB_CLASS.csv', 338260));\r\n                entries.push(buildFileEntry('/SAP Employee Central Extract', 'JOB_INFO.csv', 1546379));\r\n                entries.push(buildFileEntry('/SAP Employee Central Extract', 'LABELS.csv', 126838));\r\n                entries.push(buildFileEntry('/SAP Employee Central Extract', 'LOCATIONS.csv', 2995));\r\n                entries.push(buildFileEntry('/SAP Employee Central Extract', 'PAY_COMPONENT.csv', 1234));\r\n                entries.push(buildFileEntry('/SAP Employee Central Extract', 'PERSON_INFO_GLOBAL.csv', 82438));\r\n                entries.push(buildFileEntry('/SAP Employee Central Extract', 'PERSON.csv', 44896));\r\n                entries.push(buildFileEntry('/SAP Employee Central Extract', 'PERSONAL_DATA.csv', 105949));\r\n                entries.push(buildFileEntry('/SAP Employee Central Extract', 'PICKLISTS.csv', 78044));\r\n                entries.push(buildFileEntry('/SAP Employee Central Extract', 'TERRITORY.csv', 8541));\r\n            }\r\n            else if (folderPath.startsWith('/Test Files')) {\r\n                entries.push(buildFolderEntry('/Encoding', 21));\r\n            }\r\n            else if (folderPath.startsWith('/Encoding')) {\r\n                entries.push(buildFileEntry('/Test Files/Encoding', 'big5', 614));\r\n                entries.push(buildFileEntry('/Test Files/Encoding', 'euc-jp', 3919));\r\n                entries.push(buildFileEntry('/Test Files/Encoding', 'euc-kr', 2480));\r\n                entries.push(buildFileEntry('/Test Files/Encoding', 'gb18030', 1665));\r\n                entries.push(buildFileEntry('/Test Files/Encoding', 'iso-2022-jp', 2924));\r\n                entries.push(buildFileEntry('/Test Files/Encoding', 'iso-8859-2', 1600));\r\n                entries.push(buildFileEntry('/Test Files/Encoding', 'iso-8859-5', 1024));\r\n                entries.push(buildFileEntry('/Test Files/Encoding', 'iso-8859-6', 2241));\r\n                entries.push(buildFileEntry('/Test Files/Encoding', 'iso-8859-7', 1033));\r\n                entries.push(buildFileEntry('/Test Files/Encoding', 'koi8-r', 1024));\r\n                entries.push(buildFileEntry('/Test Files/Encoding', 'shift_jis', 2816));\r\n                entries.push(buildFileEntry('/Test Files/Encoding', 'utf-16be', 1334));\r\n                entries.push(buildFileEntry('/Test Files/Encoding', 'utf-16le', 1334));\r\n                entries.push(buildFileEntry('/Test Files/Encoding', 'utf-8', 1125));\r\n                entries.push(buildFileEntry('/Test Files/Encoding', 'windows-1250', 1617));\r\n                entries.push(buildFileEntry('/Test Files/Encoding', 'windows-1251', 1024));\r\n                entries.push(buildFileEntry('/Test Files/Encoding', 'windows-1252', 2976));\r\n                entries.push(buildFileEntry('/Test Files/Encoding', 'windows-1253', 1052));\r\n                entries.push(buildFileEntry('/Test Files/Encoding', 'windows-1254', 2445));\r\n                entries.push(buildFileEntry('/Test Files/Encoding', 'windows-1255', 2405));\r\n                entries.push(buildFileEntry('/Test Files/Encoding', 'windows-1256', 2241));\r\n            }\r\n            else {\r\n                entries.push(buildFolderEntry('/SAP Employee Central Extract', 19));\r\n                entries.push(buildFolderEntry('/Test Files', 7));\r\n            }\r\n            resolve({ cursor: undefined, isMore: false, entries, totalCount: entries.length });\r\n        }\r\n        catch (error) {\r\n            reject(error);\r\n        }\r\n    });\r\n};\r\n/**\r\n * Build a folder entry.\r\n * @param folderPath The folder entry folder path.\r\n * @param childEntryCount The folder entry child entry count.\r\n * @returns A folder entry.\r\n */\r\nconst buildFolderEntry = (folderPath, childEntryCount) => {\r\n    const lastFolderName = extractLastFolderNameFromFolderPath(folderPath);\r\n    return {\r\n        childEntryCount,\r\n        folderPath,\r\n        encodingId: undefined,\r\n        extension: undefined,\r\n        handle: undefined,\r\n        id: undefined,\r\n        label: lastFolderName,\r\n        lastModifiedAt: undefined,\r\n        mimeType: undefined,\r\n        name: lastFolderName,\r\n        referenceId: undefined,\r\n        size: undefined,\r\n        typeId: ConnectionEntryTypeId.Folder\r\n    };\r\n};\r\n/**\r\n * Build a file entry.\r\n * @param folderPath The file entry folder path.\r\n * @param name The file entry name.\r\n * @param size The file entry size.\r\n * @returns A file entry.\r\n */\r\nconst buildFileEntry = (folderPath, name, size) => {\r\n    const extension = extractExtensionFromEntryPath(name);\r\n    return {\r\n        childEntryCount: undefined,\r\n        folderPath,\r\n        encodingId: undefined,\r\n        extension,\r\n        handle: undefined,\r\n        id: name,\r\n        label: name,\r\n        lastModifiedAt: Date.parse('2022-01-03T23:33:00+00:00'),\r\n        mimeType: lookupMimeTypeForFileExtension(extension),\r\n        name,\r\n        referenceId: undefined,\r\n        size,\r\n        typeId: ConnectionEntryTypeId.File\r\n    };\r\n};\r\n// #endregion\r\n// ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\r\n// #region Preview File Entry\r\n// ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\r\n/**\r\n * Preview a file entry.\r\n * @param connector This data connector.\r\n * @param sourceViewProperties The source view properties.\r\n * @param accountId The identifier of the account to which the source belongs.\r\n * @param sessionAccessToken An active session token.\r\n * @param previewInterfaceSettings The preview interface settings.\r\n * @returns A source file entry preview.\r\n */\r\nconst previewFileEntry = async (connector, sourceViewProperties, accountId, sessionAccessToken, previewInterfaceSettings) => {\r\n    connector.abortController = new AbortController();\r\n    const signal = connector.abortController.signal;\r\n    // TODO: signal.addEventListener('abort', () => console.log('TRACE: Preview File Entry ABORTED!'), { once: true, signal }); // Don't need once and signal?\r\n    const headers = {\r\n        Range: `bytes=0-${previewInterfaceSettings.chunkSize || defaultChunkSize}`\r\n    };\r\n    const response = await fetch(`${urlPrefix}${encodeURIComponent(`${sourceViewProperties.folderPath}/${sourceViewProperties.fileName}`)}?alt=media`, { headers, signal });\r\n    connector.abortController = undefined;\r\n    if (!response.ok) {\r\n        const data = {\r\n            body: { context: 'previewFileEntry', message: await response.text() },\r\n            statusCode: response.status,\r\n            statusText: response.statusText\r\n        };\r\n        throw new Error('Unable to preview entry.|' + JSON.stringify(data));\r\n    }\r\n    const uint8Array = new Uint8Array(await response.arrayBuffer());\r\n    return { data: uint8Array, fields: undefined, typeId: ConnectionEntryPreviewTypeId.Uint8Array };\r\n};\r\n// #endregion\r\n// ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\r\n// #region Read File Entry\r\n// ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\r\n/**\r\n * Read a file entry.\r\n * @param connector This data connector.\r\n * @param sourceViewProperties The source view properties.\r\n * @param accountId The identifier of the account to which the source belongs.\r\n * @param sessionAccessToken An active session token.\r\n * @param readInterfaceSettings The read interface settings.\r\n * @param environment\r\n */\r\nconst readFileEntry = async (connector, sourceViewProperties, accountId, sessionAccessToken, readInterfaceSettings, csvParse) => {\r\n    connector.abortController = new AbortController();\r\n    const signal = connector.abortController.signal;\r\n    // TODO: signal.addEventListener('abort', () => console.log('TRACE: Read File Entry ABORTED!'), { once: true, signal }); // Don't need once and signal?\r\n    const response = await fetch(`${urlPrefix}${encodeURIComponent(`${sourceViewProperties.folderPath}/${sourceViewProperties.fileName}`)}?alt=media`, { signal });\r\n    let chunk = [];\r\n    const fieldInfos = [];\r\n    const maxChunkSize = 1000;\r\n    signal.throwIfAborted();\r\n    const parser = csvParse.parse({\r\n        cast: (value, context) => {\r\n            fieldInfos[context.index] = { isQuoted: context.quoting };\r\n            return value;\r\n        },\r\n        delimiter: sourceViewProperties.preview.valueDelimiterId,\r\n        info: true,\r\n        relax_column_count: true,\r\n        relax_quotes: true\r\n    });\r\n    parser.on('readable', () => {\r\n        let data;\r\n        while ((data = parser.read()) !== null) {\r\n            signal.throwIfAborted();\r\n            chunk.push({ fieldInfos, fieldValues: data.record });\r\n            if (chunk.length < maxChunkSize)\r\n                continue;\r\n            readInterfaceSettings.chunk(chunk);\r\n            chunk = [];\r\n        }\r\n    });\r\n    parser.on('error', (error) => readInterfaceSettings.error(error));\r\n    parser.on('end', () => {\r\n        signal.throwIfAborted();\r\n        connector.abortController = undefined;\r\n        if (chunk.length > 0) {\r\n            readInterfaceSettings.chunk(chunk);\r\n            chunk = [];\r\n        }\r\n        readInterfaceSettings.complete({\r\n            commentLineCount: parser.info.comment_lines,\r\n            emptyLineCount: parser.info.empty_lines,\r\n            lineCount: parser.info.lines,\r\n            recordCount: parser.info.records\r\n        });\r\n    });\r\n    // TODO: csvParse seems to have some support for encoding. Need to test if this can be used to replace TextDecoderStream?.\r\n    const stream = response.body.pipeThrough(new TextDecoderStream(sourceViewProperties.preview.encodingId));\r\n    const decodedStreamReader = stream.getReader();\r\n    let result;\r\n    while (!(result = await decodedStreamReader.read()).done) {\r\n        signal.throwIfAborted();\r\n        parser.write(result.value, (error) => {\r\n            if (error)\r\n                readInterfaceSettings.error(error);\r\n        });\r\n    }\r\n    parser.end();\r\n};\r\n// #endregion\r\n","references":["/Users/jonathanterrell/Data Positioning/GitHub/connectors/data/datapos-connector-data-file-store-emulator/src/config.json","/Users/jonathanterrell/Data Positioning/GitHub/connectors/data/datapos-connector-data-file-store-emulator/package.json","/Users/jonathanterrell/Data Positioning/GitHub/connectors/data/datapos-connector-data-file-store-emulator/node_modules/@datapos/datapos-engine/dist/types/index.d.ts","/Users/jonathanterrell/Data Positioning/GitHub/connectors/data/datapos-connector-data-file-store-emulator/node_modules/@datapos/datapos-engine/dist/types/index.d.ts","/Users/jonathanterrell/Data Positioning/GitHub/connectors/data/datapos-connector-data-file-store-emulator/node_modules/csv-parse/dist/esm/index.d.ts","/Users/jonathanterrell/Data Positioning/GitHub/connectors/data/datapos-connector-data-file-store-emulator/node_modules/csv-parse/dist/esm/index.d.ts"],"dts":{"name":"/Users/jonathanterrell/Data Positioning/GitHub/connectors/data/datapos-connector-data-file-store-emulator/node_modules/.cache/rollup-plugin-typescript2/placeholder/src/index.d.ts","writeByteOrderMark":false,"text":"/**\r\n * @author Jonathan Terrell <terrell.jm@gmail.com>\r\n * @copyright 2023 Jonathan Terrell\r\n * @file datapos-connector-data-file-store-emulator/src/index.ts\r\n * @license ISC\r\n */\r\nimport type { ConnectionEntry, ConnectionEntriesPage, ConnectionItem, DataConnector, DataConnectorPreviewInterface, DataConnectorReadInterface } from '@datapos/datapos-engine';\r\n/**\r\n * Encapsulates the File Store Emulator data connector.\r\n */\r\nexport default class FileStoreEmulatorDataConnector implements DataConnector {\r\n    abortController: AbortController;\r\n    readonly connectionItem: ConnectionItem;\r\n    readonly id: string;\r\n    readonly version: string;\r\n    constructor(connectionItem: ConnectionItem);\r\n    /**\r\n     * Abort current processing.\r\n     */\r\n    abort(): void;\r\n    /**\r\n     * Get the preview interface.\r\n     * @returns The preview interface.\r\n     */\r\n    getPreviewInterface(): DataConnectorPreviewInterface;\r\n    /**\r\n     * Get the read interface.\r\n     * @returns The read interface.\r\n     */\r\n    getReadInterface(): DataConnectorReadInterface;\r\n    /**\r\n     * Retrieve a page of entries for a given folder path.\r\n     * @param accountId The identifier of the account to which the source belongs.\r\n     * @param sessionAccessToken An active session access token.\r\n     * @param parentConnectionEntry\r\n     * @returns A page of entries.\r\n     */\r\n    retrieveEntries(accountId: string, sessionAccessToken: string, parentConnectionEntry: ConnectionEntry): Promise<ConnectionEntriesPage>;\r\n}\r\n"}}
